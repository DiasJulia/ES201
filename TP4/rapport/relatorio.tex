\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[french]{babel}
\usepackage[margin=2cm]{geometry} 
\usepackage{array, tabularx, booktabs, multirow}
\usepackage[table,dvipsnames]{xcolor} 
\usepackage{amsmath, graphicx, float, subcaption}
\usepackage{titlesec} 
\usepackage{palatino} 
\usepackage[scaled]{helvet}

\titleformat{\section}{\Large\bfseries\sffamily\color{MidnightBlue}}{\thesection}{1em}{}[\titlerule]
\titleformat{\subsection}{\large\bfseries\sffamily\color{RoyalBlue}}{\thesubsection}{1em}{}

\title{TP4 : Architecture des microprocesseurs}
\author{
    Júlia Ellen Dias Leite \\
    \texttt{julia-ellen@ensta-paris.fr}
}

\begin{document}

\maketitle

\section*{Exercice 3 : Analyse des Performances de la Hiérarchie Mémoire}

\subsection*{Q1.Configurer le simulateur gem5 avec deux hiérarchies de caches différentes (C1 et C2) et extraire les taux de défauts (Miss Rates) pour l'Instruction Cache (L1I), le Data Cache (L1D) et le cache unifié de niveau 2 (L2).}

% --- Tableau 8 ---
\begin{table}[h]
    \centering
    \caption{Paramètres de cache pour chaque configuration}
    \vspace{0.5em}
    \begin{tabularx}{\textwidth}{|>{\centering\arraybackslash}m{3cm}|*{3}{>{\centering\arraybackslash}X|}}
        \hline
        \textbf{Configuration} & \textbf{IL1} & \textbf{DL1} & \textbf{UL2} \\ \hline
        C1 & 4kB, DM (assoc=1) & 4kB, DM (assoc=1) & 32kB, DM (assoc=1) \\ \hline
        C2 & 4kB, DM (assoc=1) & 4kB, 2-way (assoc=2) & 32kB, 4-way (assoc=4) \\ \hline
    \end{tabularx}
\end{table}

\vspace{1cm} 

\subsection*{Q2. Remplir les tableaux de mesures pour les différents programmes fournis (P1 à P4).}

% --- Tableau 9 ---
\begin{table}[h]
    \centering
    \caption{Instruction Cache (il1) Miss Rate}
    \vspace{0.5em}
    \begin{tabularx}{0.8\textwidth}{|>{\centering\arraybackslash}m{3cm}|*{2}{>{\centering\arraybackslash}X|}}
        \hline
        \multirow{2}{*}{\textbf{Programmes}} & \multicolumn{2}{c|}{\textbf{\textcolor{blue}{Configurations de caches}}} \\ \cline{2-3} 
                                   & \textbf{C1} & \textbf{C2} \\ \hline
        P1 (normale)               & 0.000119    &  0.000119   \\ \hline
        P2 (pointeur)              & 0.000089    &  0.000089   \\ \hline
        P3 (tempo)                 & 0.000123    &  0.000123   \\ \hline
        P4 (unrol)                 & 0.000141    &  0.000141   \\ \hline
    \end{tabularx}
\end{table}

% --- Tableau 10 ---
\begin{table}[h]
    \centering
    \caption{Data Cache (dl1) Miss Rate}
    \vspace{0.5em}
    \begin{tabularx}{0.8\textwidth}{|>{\centering\arraybackslash}m{3cm}|*{2}{>{\centering\arraybackslash}X|}}
        \hline
        \multirow{2}{*}{\textbf{Programmes}} & \multicolumn{2}{c|}{\textbf{\textcolor{blue}{Configurations de caches}}} \\ \cline{2-3} 
                                   & \textbf{C1} & \textbf{C2} \\ \hline
        P1 (normale)               &  0.298316   & 0.306917    \\ \hline
        P2 (pointeur)              &  0.299729   & 0.308452    \\ \hline
        P3 (tempo)                 &  0.299724   & 0.308445    \\ \hline
        P4 (unrol)                 &  0.300090   & 0.305467    \\ \hline
    \end{tabularx}
\end{table}

% --- Tableau 11 ---
\begin{table}[h]
    \centering
    \caption{Unified Cache (ul2) Miss Rate}
    \vspace{0.5em}
    \begin{tabularx}{0.8\textwidth}{|>{\centering\arraybackslash}m{3cm}|*{2}{>{\centering\arraybackslash}X|}}
        \hline
        \multirow{2}{*}{\textbf{Programmes}} & \multicolumn{2}{c|}{\textbf{\textcolor{blue}{Configurations de caches}}} \\ \cline{2-3} 
                                   & \textbf{C1} & \textbf{C2} \\ \hline
        P1 (normale)               & 0.437203    & 0.423355    \\ \hline
        P2 (pointeur)              & 0.437227    & 0.423262    \\ \hline
        P3 (tempo)                 & 0.437231    & 0.423260    \\ \hline
        P4 (unrol)                 & 0.434496    & 0.425146    \\ \hline
    \end{tabularx}
\end{table}

\subsection*{Q3. Analysez les résultats obtenus. Pourquoi observe-t-on des variations de performance entre C1 et C2 ? Quel est l'impact de l'associativité sur les taux de défauts observés ?}

D'après les résultats obtenus dans les Tableaux 9, 10 et 11, nous pouvons tirer les conclusions suivantes :

\begin{enumerate}
    \item \textbf{Analyse de l'IL1 :} Le taux de défauts reste identique entre C1 et C2. Cela s'explique par le fait que la configuration de l'IL1 n'a pas été modifiée (4kB, Direct Mapped dans les deux cas).
    
    \item \textbf{Analyse de la DL1 :} On observe une légère augmentation du Miss Rate en C2 (2-way) par rapport à C1 (DM) pour certains programmes. Bien que l'associativité réduise normalement les défauts de conflit, dans des caches de très petite taille (4kB), l'algorithme de remplacement (LRU) peut parfois évincer des données utiles prématurément par rapport à un mapping direct, ou la structure de l'accès aux données des boucles favorise un mapping fixe.
    
    \item \textbf{Analyse de l'UL2 :} L'augmentation de l'associativité (de DM à 4-way) dans le cache L2 de 32kB montre une amélioration systématique (baisse du Miss Rate) pour C2. Cela démontre que pour un cache de second niveau recevant des flux de données et d'instructions, une associativité plus élevée est cruciale pour réduire les défauts de conflit entre les blocs provenant de la L1I et de la L1D.
\end{enumerate}

% Code to generate stats: 
% build/RISCV/gem5.opt -d /home/julia/gem5/m5out_blowfish /home/julia/gem5/ES201-GIT/ES201-TP/se_fu.py --cmd=/home/julia/gem5/ES201-GIT/TP4/Projet/blowfish/bf.riscv --args="e /home/julia/gem5/ES201-GIT/TP4/Projet/blowfish/input_small.asc /home/julia/gem5/m5out_blowfish/out.bin 0123456789abcdef
% Sabe-se lá como
% Isso gera um arquivo stats.txt dentro da pasta m5out_blowfish, onde estão as estatísticas de desempenho do programa.
% Para extrair os Miss Rates, basta procurar pelas linhas correspondentes a cada cache e calcular o Miss Rate usando as contagens de acessos e defeitos.
% Como eu não confio em mim criei um script Python pra calcular isso

\section*{Exercice 4 : Mémoires caches - Evaluation des performances de différentes
configurations de mémoires caches (instructions et données)}

L'objectif principal est la caractérisation détaillée de deux cœurs distincts : le Cortex-A7 (cœur à haut rendement et à exécution séquentielle) et le Cortex-A15 (cœur à hautes performances et à exécution déséquilibrée), à l'aide du simulateur d'architecture gem5 et de l'outil de modélisation physique CACTI.

\subsection*{Q1. Générez le pourcentage de chaque classe d'instructions de ces applications et remplissez
les valeurs dans un tableau.}

Pour générer le pourcentage de chaque classe d'instructions, nous avons utilisé les statistiques de performance extraites du simulateur gem5 pour les applications Blowfish et Dijkstra. Les classes d'instructions sont regroupées en catégories telles que IntAlu, IntMult, IntDiv, MemRead, MemWrite, FloatMemWrite, et No\_OpClass.

% --- Tableau Q1 ---
\begin{table}[h]
    \centering
    \caption{Pourcentage par classe d'instructions (blowfish, dijkstra)}
    \vspace{0.5em}
    \begin{tabularx}{0.9\textwidth}{|>{\centering\arraybackslash}m{4cm}|*{2}{>{\centering\arraybackslash}X|}}
        \hline
        \textbf{Classe} & \textbf{Blowfish} & \textbf{Dijkstra} \\ \hline
        IntAlu & 65.48\% & 63.95\% \\ \hline
        IntMult & 0.00\% & 3.30\% \\ \hline
        IntDiv & 0.00\% & 0.00\% \\ \hline
        MemRead & 22.51\% & 22.38\% \\ \hline
        MemWrite & 12.01\% & 10.36\% \\ \hline
        FloatMemWrite & 0.00\% & 0.00\% \\ \hline
        No\_OpClass & 0.00\% & 0.00\% \\ \hline
    \end{tabularx}
\end{table}

\subsection*{Q2. Quelle catégorie d'instructions nécessiterait une amélioration de performances ?
Expliquez en quelques lignes (max 5 lignes).}

La catégorie la plus critique est MemRead/MemWrite (mémoire), car elle représente une part importante des instructions et subit les latences mémoire. 
Améliorer cette catégorie (meilleure hiérarchie de caches, prélecture, réduction des accès) aura l’impact le plus direct sur le temps d’exécution. 
Les IntAlu dominent en volume mais sont déjà rapides, donc moins sensibles.

\subsection*{Q3. Au regard des résultats obtenus lors du TP2, pouvez-vous justifier d’éventuelles
similitudes/divergences comportementales entre dijkstra, BlowFish, SSCA2-BCS, SHA-1 et le
produit de polynômes ?}

Dijkstra et Blowfish ont des profils d'instructions similaires (dominance d'IntAlu et MemRead/Write), ce qui explique des comportements de cache comparables.

\subsection*{Q4 : Générez les figures de performances détaillées (performance générale, IPC, hiérarchie
mémoire, prédiction de branchement, etc.) en fonction de la taille du cache L1 pour les
configurations testées. Analysez les résultats. Quelle configuration de L1 donne les meilleures
performances pour le Cortex A7 pour les applications sélectionnées ?}

Pour analyser les performances du Cortex A7 avec les différentes tailles de cache L1, nous avons généré des figures détaillées pour l'IPC (Instructions Par Cycle) et le CPI (Cycles Par Instruction) pour les applications Blowfish et Dijkstra.

% Incluir aqui as imagens que tão em figures/figures_A7 para cada configuração de cache L1 (C1 e C2) e para cada aplicação (Blowfish, Dijkstra, etc.).
La metrique de l'IPC (Instructions Par Cycle) est un indicateur clé de la performance d'un processeur, mesurant le nombre d'instructions exécutées par cycle d'horloge.

\begin{figure}[H]
\centering
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A7/blowfish_ipc.png}
  \caption{Blowfish}
  \label{fig:blowfish_ipc}
\end{subfigure}
\hfill
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A7/dijkstra_ipc.png}
  \caption{Dijkstra}
  \label{fig:dijkstra_ipc}
\end{subfigure}
\caption{IPC sur Cortex A7 avec différentes configurations de cache L1}
\label{fig:ipc_a7}
\end{figure}

La metrique du CPI (Cycles Par Instruction) est également cruciale, car elle indique le nombre de cycles d'horloge nécessaires pour exécuter une instruction. Un CPI plus bas signifie une meilleure performance.

\begin{figure}[H]
\centering
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A7/blowfish_cpi.png}
  \caption{Blowfish}
  \label{fig:blowfish_cpi}
\end{subfigure}
\hfill
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A7/dijkstra_cpi.png}
  \caption{Dijkstra}
  \label{fig:dijkstra_cpi}
\end{subfigure}
\caption{cpi sur Cortex A7 avec différentes configurations de cache L1}
\label{fig:cpi_a7}
\end{figure}


\subsection*{Q5 : Générez les figures de performances détaillées (performance générale, IPC, hiérarchie
mémoire, prédiction de branchement, etc.) en fonction de la taille du cache L1 pour les
configurations testées. Analysez les résultats. Quelle configuration de L1 donne les
meilleures performances pour le Cortex A15 pour les applications sélectionnées ?}

\begin{figure}[H]
\centering
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A15/blowfish_ipc.png}
  \caption{Blowfish}
  \label{fig:blowfish_ipc}
\end{subfigure}
\hfill
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A15/dijkstra_ipc.png}
  \caption{Dijkstra}
  \label{fig:dijkstra_ipc}
\end{subfigure}
\caption{IPC sur Cortex A15 avec différentes configurations de cache L1}
\label{fig:ipc_a15}
\end{figure}

\begin{figure}[H]
\centering
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A15/blowfish_cpi.png}
  \caption{Blowfish}
  \label{fig:blowfish_cpi}
\end{subfigure}
\hfill
\begin{subfigure}{0.48\textwidth}
  \centering
  \includegraphics[width=\textwidth]{./figures/figures_A15/dijkstra_cpi.png}
  \caption{Dijkstra}
  \label{fig:dijkstra_cpi}
\end{subfigure}
\caption{cpi sur Cortex A15 avec différentes configurations de cache L1}
\label{fig:cpi_A15}
\end{figure}

\end{document}